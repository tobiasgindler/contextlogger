# TracEE Context-Logger

[![Maven Central](https://maven-badges.herokuapp.com/maven-central/io.tracee.contextlogger/contextlogger-parent/badge.svg)](https://maven-badges.herokuapp.com/maven-central/io.tracee.contextlogger/contextlogger-parent)
[![Build Status](https://api.travis-ci.org/tracee/contextlogger.svg)](https://travis-ci.org/tracee/contextlogger)
[![Coverage Status](https://img.shields.io/coveralls/tracee/contextlogger.svg)](https://coveralls.io/r/tracee/contextlogger)

> The TracEE Context-Logger project helps you to detect, to analyze and to resolve errors by automatically providing contextual invocation data like Http Paramters or SOAP Requests by writing it to your applications log files or to other kinds of targets (for example by sending the data via HTTP). To save system resources, contextual information will only be provided, if an error is detected by the context logger framework.

The *TracEE Context-Logger* is a side project of the *TracEE* project. The *TracEE* project helps you to aggregate log outputs of all of your log files. This will technically enable you to track user requests or sessions throughout your entire system, but does not have any influence on the content that will be written to the logs.

The main focus of the *TracEE Context-Logger* subproject lies on providing contextual data by outputting them to log files (or to other targets). It consist of two parts.

The first part offers a fluent api to generate human and machine readable String representations in Json format for object instances of any type.

The second part offers adapters and bindings for most popular Java EE technologies that are providing contextual invocation data in case of an error(== uncaught exception).

Like the *TracEE* project, it integrates with almost no effort - At the moment the following JavaEE technologies are supported.

* servlet 2.5+
* jax-ws
* jax-rs2
* cdi / ejb
* jms
* AspectJ / Spring-AOP
* Spring

The contextlogger uses slf4j as an abstraction for logging. Therefore all common log frameworks are supported (slf4j,log4j,...).

This project is still in an experimental stage - the api is nearly in a final state, but may change slightly during further development.

# Getting started

## The contextual information data

### So what is this all about?

An example:
- A user is using your JavaEE application. After a short time an exception was thrown on the application server. This could happen due to a lot of reasons (corrupt data, error in software, infrastructure problems).
- Usually exceptions and custom log output are going to be written to your logfiles. You will be able to detect the error, if you are monitoring your logfiles. Otherwise the only chance to detect the error is to wait for a call of an user.
- Now your operations employees or developers are going to try to analyze the cause of the error. This can be a very difficult and time consuming task. Success and speed are directly affected by the information you are able to gather from your log files. And this "context" data is usually provided by custom log statements provided by the developers.

The TracEE Context-Logger project automates the gathering and outputting of contextual invocation data.
Therefore it offers technolgy dependant adapters/handlers/interceptors that are detecting exceptions and automatically provide the invocation context data by writing it to the log files (or to other kind of connectors).
It also offers a fluent api to build human and machine-readable string representation for any kind of object instances.

### But how does it look like ?

The following output was generated by the tracee-examples applications after an uncaught exception in a JaxWs was thrown. The output was written by a JaxWS service handler and a servlet filter provided by the TracEE Context-Logger. 

	13:51:36.929 [http-bio-9080-exec-5] ERROR i.t.c.connector.LogConnector - [08f0d3700af5309b0ee3d140dd740cf4|6P22I7Z28VWEFMBV6U1HH5GITO8PTZ3M] - TRACEE_CL_ERROR[JAX-WS]  : [
	  "TYPE:Object[]",
	  {
		"TYPE":"jaxWs",
		"soapResponse":"String['<soap:Envelope xmlns:soap=\"http:\/\/schemas.xmlsoap.org\/soap\/envelope\/\"><SOAP-ENV:Header xmlns:SOAP-ENV=\"http:\/\/schemas.xmlsoap.org\/soap\/envelope\/\"\/><soap:Body><soap:Fault><faultcode>soap:Server<\/faultcode><faultstring>JAXWS Tracee Example : Triggered exception with passed parameters '3121' and '0' while invoking public int io.tracee.examples.jaxws.service.TraceeJaxWsTestService.error(int,int) with params [3121, 0].<\/faultstring><\/soap:Fault><\/soap:Body><\/soap:Envelope>']",
		"soapRequest":"String['<soap:Envelope xmlns:soap=\"http:\/\/schemas.xmlsoap.org\/soap\/envelope\/\"><SOAP-ENV:Header xmlns:SOAP-ENV=\"http:\/\/schemas.xmlsoap.org\/soap\/envelope\/\"><TPIC xmlns=\"http:\/\/tracee.io\/tpic\/1.0\"><entry key=\"TPIC.invocationId\">6P22I7Z28VWEFMBV6U1HH5GITO8PTZ3M<\/entry><entry key=\"TPIC.sessionId\">08f0d3700af5309b0ee3d140dd740cf4<\/entry><\/TPIC><\/SOAP-ENV:Header><soap:Body><ns2:error xmlns:ns2=\"https:\/\/github.com\/tracee\/tracee\/examples\/jaxws\/service\/wsdl\"><arg0>3121<\/arg0><arg1>0<\/arg1><\/ns2:error><\/soap:Body><\/soap:Envelope>']"
	  }
	]
	...
	13:51:37.368 [http-bio-9080-exec-3] ERROR i.t.c.connector.LogConnector - [08f0d3700af5309b0ee3d140dd740cf4|6P22I7Z28VWEFMBV6U1HH5GITO8PTZ3M] - TRACEE_CL_ERROR[TraceeErrorLoggingFilter]  : [
	  "TYPE:Object[]",
	  {
		"TYPE":"servletRequest",
		"http-method":"String['POST']",
		"http-parameters":[
		  "TYPE:ArrayList",
		  {
			"name":"String['j_idt13']",
			"value":"String['j_idt13']"
		  },
		  {
			"name":"String['j_idt13:j_idt23']",
			"value":"String['3121']"
		  },
		  {
			"name":"String['j_idt13:j_idt25']",
			"value":"String[]"
		  },
		  {
			"name":"String['j_idt13:j_idt43']",
			"value":"String['Trigger uncaught Exception']"
		  },
		  {
			"name":"String['javax.faces.ViewState']",
			"value":"String['-7205603806442056524:-6891029251268203353']"
		  }
		],
		"url":"String['http:\/\/localhost:9080\/traceeTestWebapp\/index.jsf']"
	  },
	  {
		"TYPE":"servletResponse",
		"http-status-code":"Integer['500']"
	  },
	  {
		"TYPE":"throwable",
		"stacktrace":"String['javax.servlet.ServletException: javax.xml.ws.soap.SOAPFaultException: JAXWS Tracee Example : Triggered exception with passed parameters '3121' and '0' while invoking public int io.tracee.examples.jaxws.service.TraceeJaxWsTestService.error(int,int) with params [3121, 0].\r\n\tat javax.faces.webapp.FacesServlet.service(FacesServlet.java:606)\r\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:303)\r\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\r\n\tat org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)\r\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\r\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\r\n\tat io.tracee.binding.servlet.TraceeFilter.doFilterHttp(TraceeFilter.java:63)\r\n\tat io.tracee.binding.servlet.TraceeFilter.doFilter(TraceeFilter.java:48)\r\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\r\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\r\n\tat io.tracee.contextlogger.contextprovider.servlet.TraceeErrorLoggingFilter.doFilter(TraceeErrorLoggingFilter.java:30)\r\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\r\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\r\n\tat io.tracee.examples.webapp.TraceeExampleFilter.doFilter(TraceeExampleFilter.java:27)\r\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\r\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\r\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:220)\r\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:122)\r\n\tat org.apache.tomee.catalina.OpenEJBValve.invoke(OpenEJBValve.java:44)\r\n\tat org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:501)\r\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)\r\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:103)\r\n\tat org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:950)\r\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)\r\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)\r\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1070)\r\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:611)\r\n\tat org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:316)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\r\n\tat java.lang.Thread.run(Thread.java:745)\r\nCaused by: javax.faces.el.EvaluationException: javax.xml.ws.soap.SOAPFaultException: JAXWS Tracee Example : Triggered exception with passed parameters '3121' and '0' while invoking public int io.tracee.examples.jaxws.service.TraceeJaxWsTestService.error(int,int) with params [3121, 0].\r\n\tat javax.faces.component.MethodBindingMethodExpressionAdapter.invoke(MethodBindingMethodExpressionAdapter.java:102)\r\n\tat com.sun.faces.application.ActionListenerImpl.processAction(ActionListenerImpl.java:102)\r\n\tat javax.faces.component.UICommand.broadcast(UICommand.java:315)\r\n\tat javax.faces.component.UIViewRoot.broadcastEvents(UIViewRoot.java:794)\r\n\tat javax.faces.component.UIViewRoot.processApplication(UIViewRoot.java:1259)\r\n\tat com.sun.faces.lifecycle.InvokeApplicationPhase.execute(InvokeApplicationPhase.java:81)\r\n\tat com.sun.faces.lifecycle.Phase.doPhase(Phase.java:101)\r\n\tat com.sun.faces.lifecycle.LifecycleImpl.execute(LifecycleImpl.java:118)\r\n\tat javax.faces.webapp.FacesServlet.service(FacesServlet.java:593)\r\n\t... 31 more\r\nCaused by: javax.xml.ws.soap.SOAPFaultException: JAXWS Tracee Example : Triggered exception with passed parameters '3121' and '0' while invoking public int io.tracee.examples.jaxws.service.TraceeJaxWsTestService.error(int,int) with params [3121, 0].\r\n\tat org.apache.cxf.jaxws.JaxWsClientProxy.invoke(JaxWsClientProxy.java:158)\r\n\tat com.sun.proxy.$Proxy224.error(Unknown Source)\r\n\tat io.tracee.examples.webapp.TestWebappController.triggerJaxWsRemoteError(TestWebappController.java:80)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:497)\r\n\tat org.apache.el.parser.AstValue.invoke(AstValue.java:278)\r\n\tat org.apache.el.MethodExpressionImpl.invoke(MethodExpressionImpl.java:273)\r\n\tat com.sun.faces.facelets.el.TagMethodExpression.invoke(TagMethodExpression.java:105)\r\n\tat javax.faces.component.MethodBindingMethodExpressionAdapter.invoke(MethodBindingMethodExpressionAdapter.java:88)\r\n\t... 39 more\r\nCaused by: org.apache.cxf.binding.soap.SoapFault: JAXWS Tracee Example : Triggered exception with passed parameters '3121' and '0' while invoking public int io.tracee.examples.jaxws.service.TraceeJaxWsTestService.error(int,int) with params [3121, 0].\r\n\tat org.apache.cxf.binding.soap.interceptor.Soap11FaultInInterceptor.unmarshalFault(Soap11FaultInInterceptor.java:84)\r\n\tat org.apache.cxf.binding.soap.interceptor.Soap11FaultInInterceptor.handleMessage(Soap11FaultInInterceptor.java:51)\r\n\tat org.apache.cxf.binding.soap.interceptor.Soap11FaultInInterceptor.handleMessage(Soap11FaultInInterceptor.java:40)\r\n\tat org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:263)\r\n\tat org.apache.cxf.interceptor.AbstractFaultChainInitiatorObserver.onMessage(AbstractFaultChainInitiatorObserver.java:113)\r\n\tat org.apache.cxf.jaxws.handler.soap.SOAPHandlerInterceptor.handleMessage(SOAPHandlerInterceptor.java:140)\r\n\tat org.apache.cxf.jaxws.handler.soap.SOAPHandlerInterceptor.handleMessage(SOAPHandlerInterceptor.java:71)\r\n\tat org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:263)\r\n\tat org.apache.cxf.endpoint.ClientImpl.onMessage(ClientImpl.java:845)\r\n\tat org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.handleResponseInternal(HTTPConduit.java:1705)\r\n\tat org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.handleResponse(HTTPConduit.java:1538)\r\n\tat org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.close(HTTPConduit.java:1445)\r\n\tat org.apache.cxf.transport.AbstractConduit.close(AbstractConduit.java:56)\r\n\tat org.apache.cxf.transport.http.HTTPConduit.close(HTTPConduit.java:660)\r\n\tat org.apache.cxf.interceptor.MessageSenderInterceptor$MessageSenderEndingInterceptor.handleMessage(MessageSenderInterceptor.java:62)\r\n\tat org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:263)\r\n\tat org.apache.cxf.endpoint.ClientImpl.doInvoke(ClientImpl.java:570)\r\n\tat org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:479)\r\n\tat org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:382)\r\n\tat org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:335)\r\n\tat org.apache.cxf.frontend.ClientProxy.invokeSync(ClientProxy.java:96)\r\n\tat org.apache.cxf.jaxws.JaxWsClientProxy.invoke(JaxWsClientProxy.java:136)\r\n\t... 49 more\r\n']",
		"message":"String['javax.xml.ws.soap.SOAPFaultException: JAXWS Tracee Example : Triggered exception with passed parameters '3121' and '0' while invoking public int io.tracee.examples.jaxws.service.TraceeJaxWsTestService.error(int,int) with params [3121, 0].']"
	  }
	]

As you can see the context data needed to analyze the error has been written to the logs. But that's not everything - The output can be easily configured via pre defined or custom profiles.
In that way it's possible to enable output for additional context information like cookies, session or request attributes just by changing the default profile by setting a system property.

### Detecting errors

Detecting errors using in logfiles is a difficult task. A common approach is to search for known errors like NullPointerExceptions, TimeoutExceptions or other error types you have encountered in the past.  

The TracEE Context-Logger project allows you to easily detect errors by using a fix log statement structure:

	<LOG STATEMENT HEADER PROVIDED BY LOG FRAMEWORK> TRACEE_CL_ERROR[<SOURCE>]  : <CONTEXUAL DATA> 

The TracEE Context-Logger uses a fix log statement prefix. So it's easy to detect all errors just by searching for the log statement prefix string  "TRACEE_CL_ERROR" on your log server. 

## Building of string representations for object instances
The TraceeToStringBuilder is very easy to use:

	// generates a string representation for passed instance using default profiles
	TraceeToStringBuilder.createDefault().toString(instance1,instance2,...);
	
	// Prepares preconfigured TraceeToStringBuilder instance. Note: output will be generated on first toString() method call. Should be used with log frameworks.
	TraceeToStringBuilder.createDefault().wrap(instance1,instance2,...);
	
	// overrides default config
	TraceeToStringBuilder.create()
		// override output style
		.enforceOutputWriterConfiguration(BasicOutputWriterConfiguration.JSON_INTENDED)  
		// override Tracee context provider profile settings
		.enforceProfile(Profile.FULL)	
		// disabled processing of passed types
		.disableTypes(TypeX.class)
		// closes configuration
		.apply()
		.toString(instance1,instance2,...);
    		

### How to generate String representations

### How is it done ? 
The creation of string representation is done in two phases.
The first phase is used to recursively create an output element tree which will be processed in the second phase to build the string representation.

#### First phase : building output element tree
The TraceeToStringBuilder fluent api supports object instances of any kind of types. 
Given input types are classified in the following categories:

| Output Element Type    | Description |
| --------------------:  |:-----------:|
|Tracee Context Provider | Tracee offers the possibility to define context providers which handle the output element tree creation for a specific type. Passed object instances will automatically wrapped by context provider.Context provider output can be directly configure by using profiles. Will be handled as COMPLEX output element at second phase|
|COLLECTION              | Used if passed object instance is either an array or an collection. Child elements will be processed recursively|
|COMPLEX                 | Used If passed object instances type is a bean (must have at least one field with matching getter) or a Map. Child elements will be processed recursively |
|ATOMIC                  | Used as the default fallback output element. | 

Output element tree depth is limited to keep output and processing time small. Cycles or multiple usage of instances will be detected and handled by an internal references to output element caching mechanism.  

#### Second phase : building the string representation
The output element tree are processed recursively. It is possible to use different kind of output styles(for example inline/formatted Json). 


# Integrating TracEE into your application

The steps to get TracEE contextual logging up and running pretty much depend on your application scenario. The most common use case would be to provide contextual invocation data from a servlet container based frontend or an ejb based backend.

## Integration scenarios

| Framework    | Adapter |
| ----------:  |:------:|
| Servlet      | Use [contextprovider-servlet](contextprovider/servlet) as a servlet filter. |
| EJB3/CDI/JMS | Use [contextprovider-javaee](contextprovider/javaee) as an interceptor |
| JAX-RS       | Use [contextprovider-servlet](contextprovider/servlet) as a servlet filter. |
| JAX-RS2      | TODO |
| JAX-WS       | Use [contextprovider-jaxws](contextprovider/jaxws) as a message listener. |
| SPRING-AOP   | Use [contextprovider-aspectj] (contextprovider/aspectj) by offering an aspect triggered by a simple java annotation|
| ASPECTJ      | Use [contextprovider-aspectj] (contextprovider/aspectj) by offering an aspect triggered by a simple java annotation|

## Modules

TracEE context logger is built highly modular. The modules you need depend on your application and the underlying frameworks and containers.
The following table describes all available TracEE-contextlogger modules and their usage scenarios.

| Module                                | Usage |
|--------------------------------------:|:-----:|
| [contextlogger-connectors](connectors)              | Provides support for writing contextual data to other target as log files (f.e. send error via Http) |
| [contextlogger-core](core)                          | The core of the context logger |
| [contextlogger-integration-test](integration-test)  | Does some integration test for custom data providers |
| [contextlprovider-javaee](contextprovider/javaee)                      | Provides support for EJB / CDI /JMS by offering interceptors |
| [contextprovider-jaxws](contextprovider/jaxws)                        | Provides support for JAXWS via Message handlers. |
| [contextprovider-provider-api](contextprovider/api)          | Provides support for Servlets via ServletFilter |
| [contextprovider-servlet](contextprovider/servlet)                    | Provides support for Servlets via ServletFilter |
| [contextprovider-aspectj](contextprovider/aspectj)                  | AspectJ / Spring-AOP powered contextual logging |

## Configuration

### Output Profile Selection
The output produced by the TracEE contextual logger can be configured very flexible by allowing you to choose between predefined and custom profiles or by offering you the possibility to overwrite profile settings by system properties.
You can choose between those profiles by setting the **io.tracee.contextlogger.profile** system property in your application server or by adding a **ProfileSelector.properties** file to your application. The property file must define the **io.tracee.contextlogger.profile** property. 
Possible values are: 

| Value    | Description |
| --------:|:-----------:|
| BASIC    | Default profile, provides most important and secure contextual information.  |
| ENHANCED | Provides additional contextual information not included in basic profile     |
| FULL     | Outputs almost everything available to the handlers - even security related data, therefore this profile shouldn't be used in production environments  |

You can combine those configurations in any way you want. The settings will be applied in a specific order. Application server wide profile selection will be overwritten by application based profile selection. If no profile selection is configured, basic profile will be used as default.

### TracEE common context information
You can add the following optional system properties to your application server configuration to configure the common context information:

| Property name | Description | Default |
| -------------:|:-----------:|:-------:|
| io.tracee.contextlogger.tracee-standard-stage | Defines the stage of the system - for example DEV, INT, TEST,... | won't be used if not set explicitly |
| io.tracee.contextlogger.tracee-standard-system | Defines the name of the system | system name will be determined automatically by calling InetAddress.getLocalHost().getHostName() |
